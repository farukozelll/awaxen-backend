# Docker Compose dosyası - Awaxen Backend Stack

services:
  # --- 1. VERİTABANI SERVİSİ (TimescaleDB) ---
  db:
    image: timescale/timescaledb:latest-pg14
    container_name: awaxen_timescale
    environment:
      POSTGRES_USER: ${DB_USER}         # .env dosyasından okur
      POSTGRES_PASSWORD: ${DB_PASSWORD} # .env dosyasından okur
      POSTGRES_DB: ${DB_NAME}           # .env dosyasından okur
    ports:
      - "5432:5432"  # Windows'tan erişmek istersen diye kapı açtık
    volumes:
      - timescaledb_data:/var/lib/postgresql/data  # Veriler silinmesin diye sakla
    restart: always

  # --- 2. BACKEND SERVİSİ (Flask) ---
  backend:
    build: .  # Dockerfile'ı kullanarak bu klasörü inşa et
    container_name: awaxen_backend
    ports:
      - "5000:5000"
    volumes:
      - .:/app  # Windows'taki kod değişimini anında içeri yansıt (Hot Reload)
    environment:
      # Backend'in DB'yi bulması için gereken adres
      DATABASE_URL: postgresql://${DB_USER}:${DB_PASSWORD}@db:5432/${DB_NAME}
      MQTT_BROKER_URL: ${MQTT_BROKER_URL}
      MQTT_BROKER_PORT: ${MQTT_BROKER_PORT}
      MQTT_USERNAME: ${MQTT_USERNAME}
      MQTT_PASSWORD: ${MQTT_PASSWORD}
      MQTT_SENSOR_TOPIC: ${MQTT_SENSOR_TOPIC}
      MQTT_CLIENT_ID: ${MQTT_CLIENT_ID}
      OPENWEATHER_API_KEY: ${OPENWEATHER_API_KEY}
      # Auth0 ayarları
      AUTH0_DOMAIN: ${AUTH0_DOMAIN}
      AUTH0_AUDIENCE: ${AUTH0_AUDIENCE}
    depends_on:
      - db  # DB açılmadan Backend çalışmasın
      - mqtt
    restart: always

  # --- 3. MQTT Broker (Mosquitto) ---
  mqtt:
    image: eclipse-mosquitto:2
    container_name: awaxen_mqtt
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    restart: always

  # --- 4. PGADMIN (Veritabanı Yönetim Arayüzü) ---
  pgadmin:
    image: dpage/pgadmin4
    container_name: awaxen_pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@awaxen.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "5050:80"
    depends_on:
      - db
    restart: always

volumes:
  timescaledb_data: